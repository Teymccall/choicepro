<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Code Testing</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .test-case.pass { border-color: #28a745; background: #f8fff9; }
        .test-case.fail { border-color: #dc3545; background: #fff8f8; }
        .test-case.warning { border-color: #ffc107; background: #fffef8; }
        .code-sample {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        .collision-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .code-result {
            padding: 5px;
            background: #e9f7ff;
            border-radius: 3px;
            font-family: monospace;
        }
        .duplicate {
            background: #ffebee !important;
            border: 2px solid #f44336;
        }
    </style>
</head>
<body>
    <h1>üß™ Generate Code Feature Testing</h1>
    
    <div class="test-section">
        <h2>üéØ Test 1: Code Collision Detection</h2>
        <p>This test generates multiple codes rapidly to check for collisions.</p>
        <button onclick="testCollisions()">Run Collision Test (Generate 1000 codes)</button>
        <div id="collision-results"></div>
    </div>

    <div class="test-section">
        <h2>‚è±Ô∏è Test 2: Timer Accuracy</h2>
        <p>Tests if frontend timer matches backend expiration logic.</p>
        <button onclick="testTimerAccuracy()">Test Timer Accuracy</button>
        <div id="timer-results"></div>
    </div>

    <div class="test-section">
        <h2>üîÑ Test 3: Code Restoration After Refresh</h2>
        <p>Simulates browser refresh scenario.</p>
        <div class="test-case warning">
            <strong>Manual Test Required:</strong>
            <ol>
                <li>Generate a code in the app</li>
                <li>Refresh the browser</li>
                <li>Check if code is still visible</li>
                <li>Expected: Code should be restored from database</li>
                <li>Actual: Code is lost (‚ùå Bug confirmed)</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>üèÉ‚Äç‚ôÇÔ∏è Test 4: Race Condition Simulation</h2>
        <p>Simulates multiple users trying to use the same code.</p>
        <button onclick="simulateRaceCondition()">Simulate Race Condition</button>
        <div id="race-results"></div>
    </div>

    <div class="test-section">
        <h2>üì± Test 5: Edge Cases</h2>
        <div class="test-case">
            <h4>Test Case 5.1: Self-Connection</h4>
            <p>‚úÖ <strong>Expected:</strong> Error "You cannot connect with yourself"</p>
            <p>‚úÖ <strong>Status:</strong> Properly handled in code (line 1380-1382)</p>
        </div>
        
        <div class="test-case">
            <h4>Test Case 5.2: Already Connected</h4>
            <p>‚úÖ <strong>Expected:</strong> Error "You are already connected with a partner"</p>
            <p>‚úÖ <strong>Status:</strong> Properly handled in code (line 1470-1472)</p>
        </div>
        
        <div class="test-case">
            <h4>Test Case 5.3: Offline Generation</h4>
            <p>‚úÖ <strong>Expected:</strong> Error "You are currently offline"</p>
            <p>‚úÖ <strong>Status:</strong> Properly handled in code (line 1462-1464)</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üîç Code Quality Analysis</h2>
        <div class="test-case fail">
            <h4>‚ùå Critical Issue: Collision Risk</h4>
            <div class="code-sample">Math.random().toString(36).substring(2, 8).toUpperCase()</div>
            <p><strong>Problem:</strong> Only ~2 billion combinations for 6-character codes</p>
            <p><strong>Risk:</strong> Birthday paradox - 50% collision chance with ~50k codes</p>
        </div>

        <div class="test-case warning">
            <h4>‚ö†Ô∏è Performance Issue: Full User Scan</h4>
            <div class="code-sample">const querySnapshot = await getDocs(usersRef);</div>
            <p><strong>Problem:</strong> Queries ALL users to find matching code</p>
            <p><strong>Impact:</strong> O(n) complexity, will slow down as user base grows</p>
        </div>

        <div class="test-case warning">
            <h4>‚ö†Ô∏è Memory Issue: No Code Cleanup</h4>
            <p><strong>Problem:</strong> Expired codes accumulate in user documents</p>
            <p><strong>Impact:</strong> Document size grows indefinitely</p>
        </div>
    </div>

    <div class="test-section">
        <h2>üõ†Ô∏è Recommended Fixes</h2>
        <div class="test-case pass">
            <h4>1. Implement Secure Code Generation</h4>
            <div class="code-sample">
const generateSecureCode = () => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    const array = new Uint8Array(6);
    crypto.getRandomValues(array);
    return Array.from(array, byte => chars[byte % chars.length]).join('');
};
            </div>
        </div>

        <div class="test-case pass">
            <h4>2. Add Global Code Collection</h4>
            <div class="code-sample">
// Instead of storing codes in user docs, use separate collection
collection: 'invite-codes'
document: {
    code: 'ABC123',
    createdBy: 'user123',
    expiresAt: timestamp,
    used: false
}
// Add composite index on (code, used, expiresAt)
            </div>
        </div>

        <div class="test-case pass">
            <h4>3. Implement Code Restoration</h4>
            <div class="code-sample">
useEffect(() => {
    const restoreActiveCode = async () => {
        if (user && !activeInviteCode) {
            const activeCode = await getActiveUserCode(user.uid);
            if (activeCode && !isExpired(activeCode)) {
                setActiveInviteCode(activeCode);
            }
        }
    };
    restoreActiveCode();
}, [user]);
            </div>
        </div>
    </div>

    <script>
        // Simulate the current code generation logic
        function generateCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function testCollisions() {
            const results = document.getElementById('collision-results');
            results.innerHTML = '<p>üîÑ Generating 1000 codes...</p>';
            
            const codes = new Set();
            const duplicates = [];
            const generatedCodes = [];
            
            for (let i = 0; i < 1000; i++) {
                const code = generateCode();
                generatedCodes.push(code);
                
                if (codes.has(code)) {
                    duplicates.push(code);
                } else {
                    codes.add(code);
                }
            }
            
            const collisionRate = (duplicates.length / 1000 * 100).toFixed(2);
            
            let html = `
                <div class="test-case ${duplicates.length > 0 ? 'fail' : 'pass'}">
                    <h4>${duplicates.length > 0 ? '‚ùå' : '‚úÖ'} Collision Test Results</h4>
                    <p><strong>Generated:</strong> 1000 codes</p>
                    <p><strong>Unique:</strong> ${codes.size} codes</p>
                    <p><strong>Collisions:</strong> ${duplicates.length} (${collisionRate}%)</p>
                </div>
            `;
            
            if (duplicates.length > 0) {
                html += `
                    <div class="test-case fail">
                        <h4>Duplicate Codes Found:</h4>
                        <p>${duplicates.join(', ')}</p>
                    </div>
                `;
            }
            
            html += '<div class="collision-test">';
            generatedCodes.slice(0, 50).forEach(code => {
                const isDuplicate = duplicates.includes(code);
                html += `<div class="code-result ${isDuplicate ? 'duplicate' : ''}">${code}</div>`;
            });
            html += '</div>';
            
            if (generatedCodes.length > 50) {
                html += `<p><em>Showing first 50 codes...</em></p>`;
            }
            
            results.innerHTML = html;
        }

        function testTimerAccuracy() {
            const results = document.getElementById('timer-results');
            
            // Simulate the timer calculation from the frontend
            const now = Date.now();
            const expiresAt = now + (10 * 60 * 1000); // 10 minutes from now
            const frontendRemaining = Math.floor((expiresAt - now) / 1000);
            
            // Simulate backend buffer logic
            const backendNow = new Date();
            backendNow.setMinutes(backendNow.getMinutes() - 1); // 1 minute buffer
            const backendExpiresAt = new Date(expiresAt);
            const backendValid = backendExpiresAt > backendNow;
            
            results.innerHTML = `
                <div class="test-case warning">
                    <h4>‚ö†Ô∏è Timer Mismatch Detected</h4>
                    <p><strong>Frontend Timer:</strong> ${frontendRemaining} seconds (${Math.floor(frontendRemaining/60)}:${(frontendRemaining%60).toString().padStart(2, '0')})</p>
                    <p><strong>Backend Buffer:</strong> 1 minute tolerance</p>
                    <p><strong>Issue:</strong> Frontend shows exact expiry, backend has buffer</p>
                    <p><strong>Risk:</strong> Code might expire on frontend but still work on backend</p>
                </div>
            `;
        }

        function simulateRaceCondition() {
            const results = document.getElementById('race-results');
            
            results.innerHTML = `
                <div class="test-case fail">
                    <h4>‚ùå Race Condition Vulnerability</h4>
                    <p><strong>Scenario:</strong> Two users simultaneously use code "ABC123"</p>
                    <div class="code-sample">
// Current flow allows race condition:
1. User B validates code "ABC123" ‚úÖ
2. User C validates code "ABC123" ‚úÖ  
3. User B starts batch write
4. User C starts batch write
5. One succeeds, one fails with confusing error
                    </div>
                    <p><strong>Fix Required:</strong> Use Firestore transactions for atomic updates</p>
                </div>
            `;
        }

        // Run collision test on page load
        window.onload = function() {
            testCollisions();
        };
    </script>
</body>
</html>
